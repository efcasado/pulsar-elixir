name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MIX_ENV: test

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip tests]')"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install mise
      uses: jdx/mise-action@v2
      with:
        experimental: true

    - name: Cache mise tools
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/share/mise
          ~/.cache/mise
        key: ${{ runner.os }}-mise-${{ hashFiles('.mise.toml') }}
        restore-keys: |
          ${{ runner.os }}-mise-

    - name: Install tools with mise
      run: mise install

    - name: Cache Mix dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build
        key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
        restore-keys: |
          ${{ runner.os }}-mix-

    - name: Cache plt files
      uses: actions/cache@v4
      id: cache-plt
      with:
        path: |
          priv/plts
        key: |
          plt-${{ runner.os }}-${{ hashFiles('**/mise.toml') }}-${{ hashFiles('**/mix.lock') }}
        restore-keys: |
          plt-${{ runner.os }}-${{ hashFiles('**/mise.toml') }}-

    - name: Get Mix dependencies
      run: mix deps.get

    - name: Check formatting
      run: mix format --check-formatted

    - name: Compile (warnings as errors)
      run: mix compile --warnings-as-errors

    - name: Check Credo
      run: mix credo --strict

    - name: Check Dialyzer
      run: mix dialyzer --format github --format dialyxir

    - name: Add broker hostnames to /etc/hosts
      run: |
        echo "127.0.0.1 broker1 broker2" | sudo tee -a /etc/hosts

    - name: Run tests
      run: mix coveralls.github --max-cases 2

    - name: Publish Test Report
      uses: dorny/test-reporter@v2.2.0
      if: always()
      with:
        name: Test Results
        path: test/reports/junit.xml
        reporter: java-junit
